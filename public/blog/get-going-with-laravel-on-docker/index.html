<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    
    <meta property="og:site_name" content="Ben Overmyer">
    <meta property="og:title" content="Get Going with Laravel on Docker by Ben Overmyer">
    <meta property="og:url" content="https://www.benovermyer.com/">
    <meta property="og:description" content="">
    <meta property="og:type" content="website" />
    
    <link rel="icon" type="image/svg+xml" href="https://www.benovermyer.com/favicon.svg">
    
        <link rel="alternate" type="application/atom+xml" title="Atom" href="https://www.benovermyer.com/atom.xml">
    
    <meta name="application-name" content="&nbsp;" />
	<title>Get Going with Laravel on Docker by Ben Overmyer</title>
	<link rel="stylesheet" type="text/css" href="https://www.benovermyer.com/main.css" />
    
</head>

<body>
	<nav>
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href="/about">About</a></li>
			<li><a href="/blog">Blog</a></li>
			<li><a href="/recipe">Recipes</a></li>
			<li><a href="/resume">Resumé</a></li>
			<li><a href="/work">Works</a></li>
            <li><a href="/rpg">RPGs</a></li>
			<li><a href="/links">Links</a></li>
            <li><a href="/currently">Currently</a></li>
		</ul>
	</nav>
	<section>
		
<h1 class="page-title">
	Get Going with Laravel on Docker
</h1>
<p class="blog-date">September 11, 2015</p>
<div class="blog-content">
<p><em>This post was updated May 14th, 2016 to significantly rework the tutorial.</em> Docker is slowly taking over the world of web infrastructure. It makes working with multiple different services easy, and the problem of “works in dev, not in prod” goes away, since you have the same environment on your local machine as you do in the production infra. It also makes things like trying out web apps without deploying them to servers really easy. Ever wanted to just check out a personal demo of, say, WordPress or Ghost? Docker makes that simple. Docker can be intimidating to start out with. It's a complex beast, but once you've gotten it set up a couple times, it'll become second nature. This article will walk through the entire process of having a completely new and fresh Mac OS X environment all the way to running Docker container with your own Laravel application. It's a long tutorial, so grab a big mug of coffee and put on your favorite track and let's get to work. <em>Note: This tutorial is for OS X. A lot of the pre-req stuff is different for Windows, so if you're running that OS, you might be better off using Docker Toolbox. Until the new Docker App comes out, anyway.</em></p>
<h1 id="prerequisites">Prerequisites</h1>
<p>The first step is getting some basic tools installed. OS X comes with git and Ruby installed, but we need to make a slight adjustment to our Ruby environment, and we'll need Homebrew to install some other things.</p>
<h2 id="homebrew">Homebrew</h2>
<p>Let's start with Homebrew. Paste this into a terminal prompt:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;
</span></code></pre>
<p>Running that will install Homebrew. Next, we'll need Homebrew Cask:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>brew install caskroom/cask/brew-cask
</span></code></pre>
<p>This is used to install binary applications that otherwise you'd use a GUI for.</p>
<h2 id="virtualbox">Virtualbox</h2>
<p>Let's install this via Homebrew Cask to make things easy.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>brew cask install virtualbox
</span></code></pre>
<h1 id="enter-docker">Enter Docker</h1>
<p>Now we get to the meat of it - installing Docker and the other tools necessary to work with containers. We're going to be using a wrapper called dinghy for this. You could use the official <a href="https://www.docker.com/toolbox">Docker Toolbox</a>, but the default VM that it provides, boot2docker, relies on vboxfs, which makes real-time updates (like <code>gulp watch</code>) really slow.</p>
<h2 id="install-docker-toolbox">Install Docker Toolbox</h2>
<p>When I originally wrote this post, Docker Toolbox made some questionable assumptions about how people were using Docker for development. Those have now been corrected, and it's safe to go ahead and install Docker Toolbox. You can get that here: <a href="https://www.docker.com/products/docker-toolbox">https://www.docker.com/products/docker-toolbox</a></p>
<h2 id="docker-is-installed-now-what">Docker is installed! Now what?</h2>
<p>Now everything is all set up and ready to get container-ing. In the next section, we'll create a basic Laravel app to get a proper Docker workflow going.</p>
<h1 id="gettingsetupforlaravel">Getting set up for Laravel</h1>
<p>For this tutorial, we're going to use the Laravel framework. This will demonstrate how to use multiple containers while not requiring us to write a ton of code to get started.</p>
<h2 id="install-composer">Install Composer</h2>
<p>PHP is installed by default with OS X, but you're going to need Composer also. Thankfully, it's a quick install:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
</span></code></pre>
<p>Make sure that composer is in your PATH in your bash/zsh profile. Look for this line: <code>~/.composer/vendor/bin</code> If it's nowhere in the file, you'll need to add something like this near the bottom of the file:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>export PATH=&quot;$PATH:~/.composer/vendor/bin&quot;
</span></code></pre>
<h2 id="install-the-laravel-cli-tool">Install the Laravel CLI tool</h2>
<p>This tool makes starting new Laravel projects much easier and faster:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>composer global require laravel/installer
</span></code></pre>
<h2 id="start-a-new-laravel-project">Start a new Laravel project</h2>
<p>In a directory that makes sense for you (I use <code>~/Source/</code> for my code projects), run this shell command:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>laravel new docker-app
</span></code></pre>
<p>This will create a new Laravel project called “docker-app” in a new docker-app directory. You're now ready to Docker-ize this app!</p>
<h1 id="dockerize">Docker-ize!</h1>
<p>The next step is to create four files that we'll use to describe our container environment. These files are <code>nginx-vhost.conf</code>, <code>supervisord.conf</code>, <code>Dockerfile</code>, and <code>docker-compose.yml</code>. Each of these is at the root of your project. The contents of each file is as follows:</p>
<h2 id="nginx-vhost-conf">nginx-vhost.conf</h2>
<p>We're using nginx as the web server for this app. We could use Apache, but for this exercise, we'll stick with nginx. The below file configures the virtualhost that will expose our Laravel app to the container.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>server {
</span><span> listen 80;
</span><span> listen [::]:80 default ipv6only=on;
</span><span> root /srv/www/public;
</span><span> index index.php;
</span><span>
</span><span> # Disable sendfile as per https://docs.vagrantup.com/v2/synced-folders/virtualbox.html
</span><span> sendfile off;
</span><span>
</span><span> # Add stdout logging
</span><span> error_log /dev/stdout info;
</span><span> access_log /dev/stdout;
</span><span>
</span><span> location / {
</span><span> try_files $uri $uri/ /index.php$is_args$args;
</span><span> }
</span><span>
</span><span> location ~ .php$ {
</span><span> try_files $uri =404;
</span><span> fastcgi_split_path_info ^(.+.php)(/.+)$;
</span><span> fastcgi_pass unix:/var/run/php5-fpm.sock;
</span><span> fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span><span> fastcgi_param SCRIPT_NAME $fastcgi_script_name;
</span><span> fastcgi_index index.php;
</span><span> include fastcgi_params;
</span><span> }
</span><span>
</span><span> location ~* .(jpg|jpeg|gif|png|css|js|ico|xml)$ {
</span><span> expires 5d;
</span><span> }
</span><span> # deny access to . files, for security
</span><span> location ~ /. {
</span><span> log_not_found off;
</span><span> deny all;
</span><span> }
</span><span>}
</span></code></pre>
<h2 id="supervisord-conf">supervisord.conf</h2>
<p>We're using Supervisor to run nginx and PHP-FPM. It makes things a little cleaner and easier. Below is the config file for Supervisor.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>[supervisord]
</span><span>nodaemon=true
</span><span>
</span><span>[program:php5-fpm]
</span><span>command=/usr/sbin/php5-fpm
</span><span>autostart=true
</span><span>autorestart=true
</span><span>priority=5
</span><span>
</span><span>[program:nginx]
</span><span>command=/usr/sbin/nginx
</span><span>autostart=true
</span><span>autorestart=true
</span><span>priority=10
</span><span>stdout_events_enabled=true
</span><span>stderr_events_enabled=true
</span></code></pre>
<h2 id="dockerfile">Dockerfile</h2>
<p>For a guide to the syntax you see below, check out the <a href="https://docs.docker.com/reference/builder/">official Docker documentation for Dockerfiles</a>.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>FROM ubuntu:14.04
</span><span>ENV DEBIAN_FRONTEND noninteractive
</span><span>RUN apt-get update -y
</span><span>RUN apt-get install -y software-properties-common
</span><span>RUN add-apt-repository ppa:nginx/development
</span><span>RUN apt-get update -y
</span><span>RUN apt-get upgrade -y
</span><span>RUN apt-get install -y supervisor nginx php5-fpm php5-cli php5-curl php5-gd php5-mysql php5-memcached php5-mcrypt
</span><span>
</span><span># Clean up to reduce container size
</span><span>RUN apt-get remove --purge -y software-properties-common
</span><span>RUN apt-get autoremove -y
</span><span>RUN apt-get clean
</span><span>RUN apt-get autoclean
</span><span>RUN echo -n &gt; /var/lib/apt/extended_states
</span><span>RUN rm -rf /var/lib/apt/lists/*
</span><span>RUN rm -rf /usr/share/man/??
</span><span>RUN rm -rf /usr/share/man/??_*
</span><span>
</span><span># Configure php-fpm to not run as a daemon
</span><span>RUN sed -e &#39;s/;daemonize = yes/daemonize = no/&#39; -i /etc/php5/fpm/php-fpm.conf
</span><span>RUN sed -e &#39;s/;listen.owner/listen.owner/&#39; -i /etc/php5/fpm/pool.d/www.conf
</span><span>RUN sed -e &#39;s/;listen.group/listen.group/&#39; -i /etc/php5/fpm/pool.d/www.conf
</span><span>
</span><span># Configure nginx to not run as a daemon
</span><span>RUN echo &quot;daemon off;&quot; &gt;&gt; /etc/nginx/nginx.conf
</span><span>
</span><span># This next line lets nginx write to your working directory
</span><span>RUN usermod -u 1000 www-data
</span><span>
</span><span># Configure nginx virtualhost
</span><span>RUN rm -Rf /etc/nginx/conf.d/*
</span><span>RUN rm -Rf /etc/nginx/sites-available/default
</span><span>ADD ./nginx-vhost.conf /etc/nginx/sites-available/default.conf
</span><span>RUN ln -s /etc/nginx/sites-available/default.conf /etc/nginx/sites-enabled/default.conf
</span><span>
</span><span># Add the application code into the container
</span><span>ADD . /srv/www
</span><span>
</span><span># Configure Supervisor
</span><span>ADD ./supervisord.conf /etc/supervisor/conf.d/supervisor.conf
</span><span>
</span><span># Fix permissions
</span><span>RUN chown -Rf www-data:www-data /srv/www/
</span><span>
</span><span># Set our working directory
</span><span>WORKDIR /srv/www
</span><span>
</span><span># Expose Ports
</span><span>EXPOSE 80
</span><span>
</span><span># And finally, run the command to kickstart everything
</span><span>CMD [&quot;/usr/bin/supervisord&quot;]
</span></code></pre>
<p>The above file is telling Docker how to build the container. It includes nginx and PHP-FPM, but it leaves database and cache store to other containers. The container's main job is to serve the Laravel application at <code>/srv/www</code> in the container on port 80 using nginx and PHP-FPM.</p>
<h2 id="docker-compose-yml">docker-compose.yml</h2>
<p>This file is what Docker Compose will use to build our stack and link up the containers the app needs to function. It defines three containers - web, db, and cache. The “volumes” part of the web container's definition here will map your source code directory on your host to the container's app directory, which will let you update your container by editing files on your host without having to rebuild the container. Under the db container, you'll see the “environment” section. This is a list of environment variables that will be set in the MySQL container. The two blank ones will use the environment variable of the same name on your host to set them inside the container, which is far more secure than putting these values into version control! Just make sure that you set them! That'll happen in your bash/zsh profile, with lines like this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>export MYSQL_ROOT_PASSWORD=supersecurepassword1
</span><span>export MYSQL_PASSWORD=anothersecurepassword2
</span></code></pre>
<p>Alright. Without further ado, here's the <code>docker-compose.yml</code> file:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>web:
</span><span> build: .
</span><span> ports:
</span><span> - &quot;8080:80&quot;
</span><span> volumes:
</span><span> - .:/srv/www
</span><span> links:
</span><span> - db
</span><span> - cache
</span><span>db:
</span><span> image: mysql:5.6
</span><span> environment:
</span><span>  MYSQL_ROOT_PASSWORD:
</span><span>  MYSQL_DATABASE: dockerapp
</span><span>  MYSQL_USER: dockerapp
</span><span>  MYSQL_PASSWORD:
</span><span>cache:
</span><span> image: memcached:latest
</span></code></pre>
<h1 id="configure-your-laravel-app">Configure your Laravel app</h1>
<p>Laravel 5.0 and later uses a <code>.env</code> file to configure the app. This is where you'll give your app the settings it needs to talk to the other services (in this case, memcached and MySQL).</p>
<h2 id="env">.env</h2>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>APP_ENV=local
</span><span>APP_DEBUG=true
</span><span>APP_KEY=dhBKg8eSVZ3tH5yuz6z40j13X13YWTJf
</span><span>
</span><span>DB_HOST=db
</span><span>DB_DATABASE=dockerapp
</span><span>DB_USERNAME=dockerapp
</span><span>DB_PASSWORD=anothersecurepassword2
</span><span>
</span><span>CACHE_DRIVER=memcached
</span><span>SESSION_DRIVER=memcached
</span><span>QUEUE_DRIVER=sync
</span><span>
</span><span>MEMCACHED_HOST=cache
</span><span>
</span><span>MAIL_DRIVER=smtp
</span><span>MAIL_HOST=mailtrap.io
</span><span>MAIL_PORT=2525
</span><span>MAIL_USERNAME=null
</span><span>MAIL_PASSWORD=null
</span><span>MAIL_ENCRYPTION=null
</span></code></pre>
<h1 id="run-your-new-application-container">Run your new application container</h1>
<p>Alright, we're just about ready for the finale. First we need to run Docker Compose against our app to get it running.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>docker-compose build
</span></code></pre>
<p>This will build your container and fetch the other two from Docker Hub. It shouldn't take too long - the longest part will be downloading mysql and memcached containers. Then, put your containers online:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>docker-compose up
</span></code></pre>
<p>Now try visiting <a href="http://192.168.99.100:8080">http://192.168.99.100:8080</a> in your browser of choice. You might have to change the IP address to match that of your Docker machine (<code>docker-machine ip default</code> will give you that). You should see the Laravel welcome screen, and your work here is complete. <em>Note: don't worry that your command prompt didn't come back. This runs in the foreground, so you'll need to use a new tab in your terminal app for other things. Or, you can use the daemon mode instead:</em></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>docker-compose up -d
</span></code></pre>
<p>Congratulations, you're now working with Docker!</p>

</div>

	</section>
	<footer>
		<p>This site is made with <a href="https://www.getzola.org">Zola</a>, my favorite static site generator. All content is copyright &copy; 2023 Ben Overmyer, all rights reserved.</p>
	</footer>
</body>

</html>
