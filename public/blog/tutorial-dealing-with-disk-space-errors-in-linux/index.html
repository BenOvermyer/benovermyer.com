<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    
    <meta property="og:site_name" content="Ben Overmyer">
    <meta property="og:title" content="Tutorial: Dealing with Disk Space Errors in Linux by Ben Overmyer">
    <meta property="og:url" content="https://www.benovermyer.com/">
    <meta property="og:description" content="">
    <meta property="og:type" content="website" />
    
    <link rel="icon" type="image/svg+xml" href="https://www.benovermyer.com/favicon.svg">
    
        <link rel="alternate" type="application/atom+xml" title="Atom" href="https://www.benovermyer.com/atom.xml">
    
    <meta name="application-name" content="&nbsp;" />
	<title>Tutorial: Dealing with Disk Space Errors in Linux by Ben Overmyer</title>
	<link rel="stylesheet" type="text/css" href="https://www.benovermyer.com/main.css" />
    
</head>

<body>
	<nav>
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href="/about">About</a></li>
			<li><a href="/blog">Blog</a></li>
			<li><a href="/recipe">Recipes</a></li>
			<li><a href="/resume">Resumé</a></li>
			<li><a href="/work">Works</a></li>
            <li><a href="/rpg">RPGs</a></li>
			<li><a href="/links">Links</a></li>
            <li><a href="/kb">KB</a></li>
            <li><a href="/currently">Currently</a></li>
		</ul>
	</nav>
	<section>
		
<h1 class="page-title">
	Tutorial: Dealing with Disk Space Errors in Linux
</h1>
<p class="blog-date">December 10, 2015</p>
<div class="blog-content">
<p>If you're seeing errors on a server (say, npm complaining about an ENOSPC error, or apt failing to install something) that suggest the hard disk is full, use this guide to resolve the issue.</p>
<h1 id="troubleshooting">Troubleshooting</h1>
<blockquote>
<p>All of the following commands assume you are logged in as a sudo user on a Linux machine. Some of the commands, like <code>df -hT</code>, won't work exactly as advertised on something like, say, Solaris.</p>
</blockquote>
<h2 id="checking-disk-space">Checking disk space</h2>
<p>First, check the amount of available disk space.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>df -hT
</span></code></pre>
<p>If one of the available drives (such as <code>/dev/xvda1</code>) shows as 100% full, then you'll need to clear some space. The first place to look is <code>/var/log/</code>, especially if nginx is writing log files to disk. Clear out all old logs (anything with a .gz file extension is fair game for deletion). If that doesn't free up enough space, the next place to check is the application directory for whatever app is on the server. If there are more than 3 releases on the server, you can safely delete the oldest ones (until you have at least 2 remaining). You can also remove all the files in <code>/tmp/</code>, although that should be a last resort.</p>
<h2 id="checking-inode-usage">Checking inode usage</h2>
<p>If you've confirmed that the hard drive isn't full (or cleared enough space that it isn't), and you're still seeing “disk is full” type errors, then you almost certainly have too few inodes available on the server. This means, basically, that there are too many files on the server.</p>
<h3 id="checking-inode-usage-1">Checking inode usage</h3>
<p>Run the following command to check inode usage:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>df -i
</span></code></pre>
<p>You'll see something like the following:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Filesystem     Inodes IUsed IFree IUse% Mounted on
</span><span>udev             121K   409  120K    1% /dev
</span><span>tmpfs            125K   479  124K    1% /run
</span><span>/dev/vda1        1.9M  237K  1.7M   13% /
</span><span>tmpfs            125K     2  125K    1% /dev/shm
</span><span>tmpfs            125K     3  125K    1% /run/lock
</span><span>tmpfs            125K    15  125K    1% /sys/fs/cgroup
</span><span>tmpfs            125K     4  125K    1% /run/user/1000
</span></code></pre>
<p>The <code>IUse%</code> column is the one you're interested in. If <code>IUse%</code> is at or near 100%, then you have an inode usage problem.</p>
<h3 id="delete-old-kernels">Delete old kernels</h3>
<p>Often, you can free up a ton of inodes if you delete old kernels. This is done with a pretty simple command:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>sudo apt-get autoremove -y
</span></code></pre>
<p>Try that first. If that doesn't remove the old kernels, <a href="http://markmcb.com/2013/02/04/cleanup-unused-linux-kernels-in-ubuntu/">this page</a> may help.</p>
<h3 id="script-to-check-for-directories-with-lots-of-files">Script to check for directories with lots of files</h3>
<p>This script will help find directories with large numbers of files. Put the following into a file <code>list-files.sh</code> in your home directory:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>#!/bin/bash
</span><span># count_em - count files in all subdirectories under current directory.
</span><span>echo &#39;echo $(ls -a &quot;$1&quot; | wc -l) $1&#39; &gt;/tmp/count_em_$
</span><span>chmod 700 /tmp/count_em_$
</span><span>find . -mount -type d -print0 | xargs -0 -n1 /tmp/count_em_$ | sort -n
</span></code></pre>
<p>Then make the file executable:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>chmod +x ./list-files.sh
</span></code></pre>
<p>Finally, go to the root directory on the server and run the script:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>cd /
</span><span>~/list-files.sh
</span></code></pre>
<p>It may take a couple minutes to run, but it will present you with a list of all the directories with a number of files next to each, sorted in ascending order of number of files. Take a look at each of the high ones; that might give you an idea of what you need to clean up.</p>
<h3 id="some-notes-about-good-files-to-delete">Some notes about good files to delete</h3>
<p>Log files are safe to delete. So are old releases. Also check the <code>/tmp/</code> directory; it can often be a hiding place for tons of files.</p>

</div>

	</section>
	<footer>
		<p>This site is made with <a href="https://www.getzola.org">Zola</a>, my favorite static site generator. All content is copyright &copy; 2023 Ben Overmyer, all rights reserved.</p>
	</footer>
</body>

</html>
