<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Notes about Docker">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    
    <meta property="og:site_name" content="Ben Overmyer">
    <meta property="og:title" content="Docker from Ben Overmyer">
    <meta property="og:url" content="https://www.benovermyer.com/">
    <meta property="og:description" content="Notes about Docker">
    <meta property="og:type" content="website" />
    
    <link rel="icon" type="image/svg+xml" href="https://www.benovermyer.com/favicon.svg">
    
        <link rel="alternate" type="application/atom+xml" title="Atom" href="https://www.benovermyer.com/atom.xml">
    
    <meta name="application-name" content="&nbsp;" />
	<title>Docker from Ben Overmyer</title>
	<link rel="stylesheet" type="text/css" href="https://www.benovermyer.com/main.css" />
    
</head>

<body>
	<nav>
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href="/about">About</a></li>
			<li><a href="/blog">Blog</a></li>
			<li><a href="/recipe">Recipes</a></li>
			<li><a href="/resume">Resum√©</a></li>
			<li><a href="/work">Works</a></li>
            <li><a href="/rpg">RPGs</a></li>
			<li><a href="/links">Links</a></li>
		</ul>
	</nav>
	<section>
		
<h1 class="page-title">
	Docker
</h1>

<h1 id="building-docker-images-on-an-internal-only-gitlab">Building Docker images on an internal-only GitLab</h1>
<p>Let's say you have an instance of GitLab set up on an internal domain name with a certificate signed by an internal root certificate authority. Let's also say that you want to set up Docker-in-Docker builds on a GitLab Runner for that instance.</p>
<p>Your GitLab runner config must have <code>privileged = true</code> for the executor, and it must be of the <code>docker</code> type.</p>
<p>The <code>.gitlab-ci.yml</code> file for your project should look something like this:</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">docker:19.03.13
</span><span>
</span><span style="color:#bf616a;">services</span><span>:
</span><span>  - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">my-internal-registry.internaldomain:5050/my-team/my-internal-dind-image:latest
</span><span>    </span><span style="color:#bf616a;">alias</span><span>: </span><span style="color:#a3be8c;">docker
</span><span>    </span><span style="color:#bf616a;">entrypoint</span><span>: [&quot;</span><span style="color:#a3be8c;">env</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">-u</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">DOCKER_HOST</span><span>&quot;]
</span><span>    </span><span style="color:#bf616a;">command</span><span>: [&quot;</span><span style="color:#a3be8c;">dockerd-entrypoint.sh</span><span>&quot;]
</span><span>
</span><span style="color:#bf616a;">variables</span><span>:
</span><span>  </span><span style="color:#bf616a;">DOCKER_HOST</span><span>: </span><span style="color:#a3be8c;">tcp://docker:2376
</span><span>  </span><span style="color:#bf616a;">DOCKER_TLS_CERTDIR</span><span>: &quot;</span><span style="color:#a3be8c;">/certs</span><span>&quot;
</span><span>
</span><span style="color:#bf616a;">before_script</span><span>:
</span><span>  - </span><span style="color:#a3be8c;">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
</span><span>
</span><span style="color:#bf616a;">build</span><span>:
</span><span>  </span><span style="color:#bf616a;">stage</span><span>: </span><span style="color:#a3be8c;">build
</span><span>  </span><span style="color:#bf616a;">script</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">VERSION_TAG=`cat VERSION`
</span><span>    - </span><span style="color:#a3be8c;">docker build --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --tag $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$VERSION_TAG .
</span><span>    - </span><span style="color:#a3be8c;">docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
</span><span>    - </span><span style="color:#a3be8c;">docker push $CI_REGISTRY_IMAGE:$VERSION_TAG
</span><span>    - </span><span style="color:#a3be8c;">docker push $CI_REGISTRY_IMAGE:latest
</span></code></pre>


	</section>
	<footer>
		<p>This site is made with <a href="https://getzola.org">Zola</a>, my favorite static site generator. All content is copyright &copy; 2023 Ben Overmyer, all rights reserved.</p>
	</footer>
</body>

</html>
