<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Notes about Chef">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
    
    <meta property="og:site_name" content="Ben Overmyer">
    <meta property="og:title" content="Chef from Ben Overmyer">
    <meta property="og:url" content="https://www.benovermyer.com/">
    <meta property="og:description" content="Notes about Chef">
    <meta property="og:type" content="website" />
    
    <link rel="icon" type="image/svg+xml" href="https://www.benovermyer.com/favicon.svg">
    
        <link rel="alternate" type="application/atom+xml" title="Atom" href="https://www.benovermyer.com/atom.xml">
    
    <meta name="application-name" content="&nbsp;" />
	<title>Chef from Ben Overmyer</title>
	<link rel="stylesheet" type="text/css" href="https://www.benovermyer.com/main.css" />
    
</head>

<body>
	<nav>
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href="/about">About</a></li>
			<li><a href="/blog">Blog</a></li>
			<li><a href="/recipe">Recipes</a></li>
			<li><a href="/resume">Resum√©</a></li>
			<li><a href="/work">Works</a></li>
            <li><a href="/rpg">RPGs</a></li>
			<li><a href="/links">Links</a></li>
            <li><a href="/currently">Currently</a></li>
		</ul>
	</nav>
	<section>
		
<h1 class="page-title">
	Chef
</h1>

<h1 id="common-chef-code-bits">Common Chef code bits</h1>
<p>To reference Chef Infra Client's cache directory, use this:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#ebcb8b;">Chef</span><span>::</span><span style="color:#ebcb8b;">Config</span><span>[</span><span style="color:#a3be8c;">:file_cache_path</span><span>]
</span></code></pre>
<h1 id="clearing-out-old-chef-nodes">Clearing out old Chef nodes</h1>
<p>If you're using Chef with cloud infrastructure that doesn't properly clean up old nodes,
you can run the following occasionally to clear them out:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#!/usr/bin/env bash
</span><span style="color:#b48ead;">for</span><span> node </span><span style="color:#b48ead;">in </span><span>$(</span><span style="color:#bf616a;">knife</span><span> search node &quot;</span><span style="color:#a3be8c;">ohai_time:[* TO </span><span>$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">date</span><span style="color:#a3be8c;"> +</span><span>%</span><span style="color:#bf616a;">s -d </span><span>&#39;</span><span style="color:#a3be8c;">30 days ago</span><span>&#39;</span><span style="color:#a3be8c;">)]</span><span>&quot;</span><span style="color:#bf616a;"> -i</span><span>); </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#bf616a;">yes</span><span>|</span><span style="color:#bf616a;">knife</span><span> client delete $</span><span style="color:#bf616a;">node
</span><span>  </span><span style="color:#bf616a;">yes</span><span>|</span><span style="color:#bf616a;">knife</span><span> node delete $</span><span style="color:#bf616a;">node
</span><span style="color:#b48ead;">done
</span></code></pre>
<p>This script produces a list of nodes (one per line, name only) with an <code>ohai_time</code> of greater than or equal to 30 days ago. The <code>ohai_time</code> is when the node last checked in with Chef Infra Server. It then deletes the client and node metadata from the server for that node.</p>
<p>You might need to change the '30 days ago' timeframe to better suit your own environment.</p>
<h1 id="automating-the-update-of-chef-infra-client-in-environments-with-internal-ca">Automating the update of Chef Infra Client in environments with internal CA</h1>
<p>When you're in an environment that has an internal certificate authority, you'll need to add that material
to Chef. The following Chef code will automate that as part of a base cookbook <code>my_base_cookbook</code> default recipe.</p>
<p>Note that this requires two external cookbooks prior to Chef Infra Client 16.5: <code>chef-client</code> and <code>chef_client_updater</code>.
Chef Infra Client 16.5 and later includes the <code>chef-client</code> functionality.</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>node.default[&#39;</span><span style="color:#a3be8c;">chef_client</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">chef_license</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">accept</span><span>&#39;
</span><span>node.default[&#39;</span><span style="color:#a3be8c;">chef_client</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">ca_cert_path</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem</span><span>&#39; // default </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">RHEL</span><span>-compatible </span><span style="color:#bf616a;">Linux
</span><span>
</span><span style="color:#b48ead;">if</span><span> platform_family?(&#39;</span><span style="color:#a3be8c;">windows</span><span>&#39;)
</span><span>  new_cert_file = &#39;</span><span style="color:#a3be8c;">C:</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">chef</span><span style="color:#96b5b4;">\\</span><span style="color:#a3be8c;">cacert.pem</span><span>&#39;
</span><span>  node.default[&#39;</span><span style="color:#a3be8c;">my_base_cookbook</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">chef_client</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">post_install_action</span><span>&#39;] = &#39;</span><span style="color:#a3be8c;">exec</span><span>&#39; // </span><span style="color:#bf616a;">Windows</span><span> needs &#39;</span><span style="color:#a3be8c;">exec</span><span>&#39;, not &#39;</span><span style="color:#a3be8c;">kill</span><span>&#39;
</span><span>  node.default[&#39;</span><span style="color:#a3be8c;">chef_client</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">ca_cert_path</span><span>&#39;] = new_cert_file
</span><span>
</span><span>  cookbook_file new_cert_file </span><span style="color:#b48ead;">do
</span><span>    source &#39;</span><span style="color:#a3be8c;">certs.pem</span><span>&#39; // this is the standard cacerts.pem chain with the addition of the internal </span><span style="color:#bf616a;">CA</span><span> certificate
</span><span>    sensitive </span><span style="color:#d08770;">true
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  env &#39;</span><span style="color:#a3be8c;">SSL_CERT_FILE</span><span>&#39; </span><span style="color:#b48ead;">do
</span><span>    value new_cert_file
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span><span>
</span><span>include_recipe &#39;</span><span style="color:#a3be8c;">chef-client</span><span>&#39;
</span><span>
</span><span>chef_client_updater &#39;</span><span style="color:#a3be8c;">Install latest Chef Infra Client</span><span>&#39; </span><span style="color:#b48ead;">do
</span><span>  version &#39;</span><span style="color:#a3be8c;">16</span><span>&#39; // or whatever version
</span><span>  post_install_action node[&#39;</span><span style="color:#a3be8c;">my_base_cookbook</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">chef_client</span><span>&#39;][&#39;</span><span style="color:#a3be8c;">post_install_action</span><span>&#39;]
</span><span style="color:#b48ead;">end
</span></code></pre>


	</section>
	<footer>
		<p>This site is made with <a href="https://www.getzola.org">Zola</a>, my favorite static site generator. All content is copyright &copy; 2023 Ben Overmyer, all rights reserved.</p>
	</footer>
</body>

</html>
